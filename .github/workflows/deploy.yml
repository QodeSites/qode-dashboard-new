name: CI/CD - Deploy Client Dashboard

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Build & Deploy to VPS
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Install rsync & ssh-client
        run: |
          sudo apt-get update
          sudo apt-get install -y rsync openssh-client
        shell: bash

      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.VPS_SSH_KEY }}" ] || [ -z "${{ secrets.VPS_USER }}" ] || [ -z "${{ secrets.VPS_HOST }}" ] || [ -z "${{ secrets.TARGET_DIR }}" ]; then
            echo "Error: Missing required secrets (VPS_SSH_KEY, VPS_USER, VPS_HOST, TARGET_DIR)"
            exit 1
          fi
        shell: bash

      - name: Set up SSH key for VPS
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${VPS_PORT:-22} ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
        env:
          VPS_PORT: ${{ secrets.VPS_PORT }}
        shell: bash

      - name: Rsync repository to VPS
        run: |
          for i in {1..3}; do
            rsync -avz --delete \
              -e "ssh -i ~/.ssh/id_rsa -p ${VPS_PORT:-22}" \
              ./ \
              ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ secrets.TARGET_DIR }} && break || { echo "Rsync attempt $i failed"; sleep 10; }
            if [ $i -eq 3 ]; then echo "Rsync failed after 3 attempts"; exit 1; fi
          done
        env:
          VPS_PORT: ${{ secrets.VPS_PORT }}
        shell: bash

      - name: SSH â†’ Build & Restart Docker Container
        run: |
          for i in {1..3}; do
            ssh -i ~/.ssh/id_rsa -p ${VPS_PORT:-22} \
              ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF' && break || { echo "SSH attempt $i failed"; sleep 10; }
            set -e
            set -x

            cd "${{ secrets.TARGET_DIR }}"

            command -v docker >/dev/null 2>&1 || { echo "Docker not found"; exit 1; }

            IMAGE_NAME="client-dashboard-app"
            for i in {1..3}; do
              docker build -t "$IMAGE_NAME" . && break || { echo "Docker build attempt $i failed"; sleep 10; }
              if [ $i -eq 3 ]; then echo "Docker build failed after 3 attempts"; exit 1; fi
            done

            if [ "$(docker ps -q --filter name=$IMAGE_NAME)" ]; then
              docker stop "$IMAGE_NAME"
              docker rm "$IMAGE_NAME"
            fi

            docker run -d \
              --name "$IMAGE_NAME" \
              -e NODE_ENV=production \
              -e NEXT_PUBLIC_API_BASE_URL="http://localhost:8010/api" \
              -p 3040:3000 \
              "$IMAGE_NAME"

            docker image prune -f
            docker container prune -f
          EOF
            if [ $i -eq 3 ]; then echo "SSH failed after 3 attempts"; exit 1; fi
          done
        env:
          VPS_PORT: ${{ secrets.VPS_PORT }}
        shell: bash